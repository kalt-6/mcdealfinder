<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Create your order and find the best combination of deals.">
    <title>McDeal Finder</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f4;
        }
        
        .mcd-red { background-color: #DA291C; }
        .mcd-yellow { color: #FFC72C; }
        
        .category-scroll::-webkit-scrollbar { height: 6px; }
        .category-scroll::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Mobile Tab Active State */
        .tab-active {
            color: #DA291C;
            font-weight: bold;
        }
        .tab-inactive {
            color: #9CA3AF;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-gray-50">

    <!-- Header -->
    <header class="mcd-red text-white p-3 shadow-md z-10 shrink-0">
        <div class="max-w-7xl mx-auto flex flex-row justify-between items-center w-full gap-2">
            <div class="flex items-center gap-2">
                <div class="text-3xl mcd-yellow"><i class="fa-brands fa-mcdonalds"></i></div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight leading-none">McDeal Finder</h1>
                    <p class="text-[10px] text-white/90 font-light hidden sm:block">Find the cheapest way to order!</p>
                </div>
            </div>
            <!-- Mobile Cart Summary (Mini) -->
            <div class="md:hidden flex items-center gap-2 bg-white/10 px-3 py-1 rounded cursor-pointer" onclick="switchTab('cart')">
                <i class="fas fa-shopping-bag text-sm"></i>
                <span id="mobileHeaderTotal" class="text-sm font-bold">$0.00</span>
            </div>
            <div class="text-xs bg-white/20 px-3 py-1 rounded text-center hidden sm:block">
                Unofficial Tool
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden max-w-7xl mx-auto w-full relative">
        
        <!-- Left Column: Menu Selection (Tab: Menu) -->
        <div id="col-menu" class="flex-1 flex flex-col border-r border-gray-200 bg-white overflow-hidden h-full md:h-auto absolute inset-0 md:relative z-0 md:z-auto md:flex">
            <!-- Categories -->
            <div class="p-2 bg-gray-50 border-b overflow-x-auto category-scroll whitespace-nowrap shrink-0" id="categoryNav"></div>

            <!-- Menu Grid -->
            <div class="flex-1 overflow-y-auto p-3 bg-gray-50 pb-32 md:pb-4" id="menuContainer">
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3" id="menuGrid"></div>
            </div>
        </div>

        <!-- Middle Column: Deals (Tab: Deals) -->
        <div id="col-deals" class="w-full md:w-80 lg:w-96 bg-white border-r border-gray-200 flex flex-col overflow-hidden md:order-none hidden md:flex h-full md:h-auto absolute inset-0 md:relative z-0 md:z-auto">
            <div class="p-3 bg-gray-100 border-b font-bold text-gray-700 flex justify-between items-center shrink-0">
                <span>Mobile Deals</span>
                <button onclick="toggleCustomDealModal()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">
                    + Add Custom
                </button>
            </div>
            
            <div class="p-2 bg-green-50 border-b border-green-100 text-xs text-green-800 flex flex-col gap-1 shrink-0">
                <div class="flex items-start gap-2">
                    <i class="fas fa-check-circle mt-0.5"></i>
                    <span><strong>Auto-BOGO:</strong> $1 on McChicken, Dbl Chz, 6pc, Sm Fry, Breakfast.</span>
                </div>
                <div class="flex items-start gap-2">
                    <i class="fas fa-utensils mt-0.5"></i>
                    <span><strong>Auto-Meal:</strong> Items convert to Meal Bundles if cheaper.</span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-3 bg-white pb-32 md:pb-3" id="dealsList"></div>
        </div>

        <!-- Right Column: Cart & Results (Tab: Cart) -->
        <div id="col-cart" class="w-full md:w-80 lg:w-96 bg-gray-50 flex flex-col shadow-xl z-20 border-t md:border-t-0 border-gray-300 hidden md:flex h-full md:h-auto absolute inset-0 md:relative z-0 md:z-auto">
            <div class="p-4 bg-white border-b shadow-sm shrink-0">
                <h2 class="font-bold text-lg flex items-center gap-2">
                    <i class="fas fa-receipt text-gray-400"></i> Your Order
                </h2>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="cartContainer">
                <div class="text-center text-gray-400 mt-10 text-sm">Your tray is empty.</div>
            </div>

            <!-- Totals & Calculate -->
            <div class="p-4 bg-white border-t space-y-3 shrink-0 pb-32 md:pb-4">
                <div class="flex justify-between text-sm text-gray-500">
                    <span>Subtotal</span>
                    <span id="subtotalDisplay">$0.00</span>
                </div>
                <div class="flex justify-between font-bold text-xl text-gray-800">
                    <span>Total</span>
                    <span id="totalDisplay">$0.00</span>
                </div>
                
                <button onclick="calculateBestDeal()" class="w-full mcd-red hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-md transition-all active:scale-95 flex justify-center items-center gap-2">
                    <i class="fas fa-calculator"></i> Find Best Deal
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Nav -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-2 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <button onclick="switchTab('menu')" class="flex flex-col items-center w-full tab-active" id="tab-menu">
            <i class="fas fa-utensils text-lg mb-1"></i>
            <span class="text-[10px]">Menu</span>
        </button>
        <button onclick="switchTab('deals')" class="flex flex-col items-center w-full tab-inactive" id="tab-deals">
            <i class="fas fa-tag text-lg mb-1"></i>
            <span class="text-[10px]">Deals</span>
        </button>
        <button onclick="switchTab('cart')" class="flex flex-col items-center w-full tab-inactive relative" id="tab-cart">
            <div class="relative">
                <i class="fas fa-shopping-bag text-lg mb-1"></i>
                <span id="cartBadge" class="hidden absolute -top-1 -right-2 bg-red-600 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] text-center h-[14px] flex items-center justify-center">0</span>
            </div>
            <span class="text-[10px]">Cart</span>
        </button>
    </div>

    <!-- Results Modal -->
    <div id="resultModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="mcd-red p-4 text-center text-white">
                <h3 class="text-xl font-bold" id="resultTitle">Savings Found!</h3>
            </div>
            <div class="p-6 text-center space-y-4">
                
                <!-- Breakdown -->
                <div class="bg-gray-50 rounded-lg p-3 text-left text-sm space-y-2 border border-gray-200">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Original Price:</span>
                        <span class="font-semibold line-through text-red-400" id="resultOriginal">$0.00</span>
                    </div>
                    <div class="border-t border-gray-200 pt-2 space-y-1">
                        <div id="dealSavingsRow" class="flex justify-between text-blue-700 hidden">
                            <span id="dealNameDisplay">+ Mobile Deal:</span>
                            <span class="font-bold" id="dealSavingsVal">-$0.00</span>
                        </div>
                         <div id="mealSavingsRow" class="flex justify-between text-purple-700 hidden">
                            <span>+ Meal Bundling:</span>
                            <span class="font-bold" id="mealSavingsVal">-$0.00</span>
                        </div>
                         <div id="autoSavingsRow" class="flex justify-between text-green-700 hidden">
                            <span>+ Auto BOGO:</span>
                            <span class="font-bold" id="autoSavingsVal">-$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-end border-b pb-4">
                    <div class="text-left">
                        <div class="text-xs text-gray-500 font-bold uppercase">Final Price</div>
                        <div class="text-4xl font-bold text-gray-800" id="resultNew">$0.00</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 font-bold uppercase">Total Saved</div>
                        <div class="text-xl font-bold text-green-600" id="resultSavings">$0.00</div>
                    </div>
                </div>
                
                <p class="text-xs text-gray-400 italic">*Estimates only. Does not include tax.</p>
            </div>
            <div class="p-4 bg-gray-50 border-t">
                <button onclick="closeModal('resultModal')" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-gray-900">Got it</button>
            </div>
        </div>
    </div>

    <!-- Custom Deal Modal -->
    <div id="customDealModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold mb-4">Add Custom Deal</h3>
            <div class="space-y-3">
                <div><label class="block text-xs font-bold text-gray-600 mb-1">Deal Name</label><input type="text" id="customName" class="w-full border rounded p-2"></div>
                <div><label class="block text-xs font-bold text-gray-600 mb-1">Type</label>
                    <select id="customType" class="w-full border rounded p-2" onchange="toggleCustomFields()">
                        <option value="percent">Percentage Off Order</option>
                        <option value="fixed_off">Amount ($) Off Order</option>
                    </select>
                </div>
                <div id="field-percent"><label class="block text-xs font-bold text-gray-600 mb-1">Percentage (0-100)</label><input type="number" id="customValPercent" class="w-full border rounded p-2"></div>
                <div id="field-amount" class="hidden"><label class="block text-xs font-bold text-gray-600 mb-1">Discount Amount ($)</label><input type="number" id="customValAmount" class="w-full border rounded p-2"></div>
                <div id="field-min" class="mt-2"><label class="block text-xs font-bold text-gray-600 mb-1">Minimum Spend ($)</label><input type="number" id="customMinSpend" class="w-full border rounded p-2" value="0"></div>
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="closeModal('customDealModal')" class="flex-1 bg-gray-200 py-2 rounded">Cancel</button>
                <button onclick="addCustomDeal()" class="flex-1 mcd-red text-white py-2 rounded">Add Deal</button>
            </div>
        </div>
    </div>

    <script>
        // --- MOBILE TAB LOGIC ---
        function switchTab(tabName) {
            // Only applies on mobile via classes 'hidden' and 'flex'
            // On desktop, we want all to stay visible (they have 'md:flex')
            
            const cols = ['col-menu', 'col-deals', 'col-cart'];
            const tabs = ['tab-menu', 'tab-deals', 'tab-cart'];
            
            // Hide all columns on mobile (remove 'flex', add 'hidden')
            // But keep 'md:flex' so desktop ignores this
            cols.forEach(c => {
                document.getElementById(c).classList.add('hidden');
                document.getElementById(c).classList.remove('flex');
            });
            
            // Show active column
            document.getElementById('col-'+tabName).classList.remove('hidden');
            document.getElementById('col-'+tabName).classList.add('flex');
            
            // Update tab styling
            tabs.forEach(t => {
                const el = document.getElementById(t);
                if(t === 'tab-'+tabName) {
                    el.classList.add('tab-active');
                    el.classList.remove('tab-inactive');
                } else {
                    el.classList.remove('tab-active');
                    el.classList.add('tab-inactive');
                }
            });
        }

        // --- MENU DATA ---
        const menu = [
            // Breakfast
            { id: 'eggmcmuffin', name: 'Egg McMuffin', price: 4.79, mealPrice: 7.99, category: 'Breakfast', img: 'ðŸ³' },
            { id: 'sausage_mcmuffin', name: 'Sausage McMuffinÂ®', price: 2.39, mealPrice: 5.69, category: 'Breakfast', img: 'ðŸ³' },
            { id: 'sausage_egg_mcmuffin', name: 'Sausage McMuffin w/ Egg', price: 5.19, mealPrice: 8.49, category: 'Breakfast', img: 'ðŸ³' },
            { id: 'sausage_biscuit', name: 'Sausage Biscuit', price: 2.29, mealPrice: 5.49, category: 'Breakfast', img: 'ðŸ¥¯' },
            { id: 'bacon_egg_biscuit', name: 'Bacon Egg Cheese Biscuit', price: 5.29, mealPrice: 8.59, category: 'Breakfast', img: 'ðŸ¥¯' },
            { id: 'sausage_burrito', name: 'Sausage Burrito', price: 2.19, mealPrice: 6.89, category: 'Breakfast', img: 'ðŸŒ¯' }, 
            { id: 'hashbrown', name: 'Hash Browns', price: 2.09, category: 'Breakfast', img: 'ðŸ¥”' },
            { id: 'becg', name: 'Bacon Egg Cheese McGriddle', price: 4.99, mealPrice: 8.29, category: 'Breakfast', img: 'ðŸ¥ž' },
            { id: 'secg', name: 'Sausage Egg McGriddle', price: 4.69, mealPrice: 7.99, category: 'Breakfast', img: 'ðŸ¥ž' },
            { id: 'hc', name: 'Hotcakes', price: 4.29, category: 'Breakfast', img: 'ðŸ¥ž' },

            // Burgers & Sandwiches
            { id: 'bigmac', name: 'Big Mac', price: 6.19, mealPrice: 8.89, category: 'Burgers', img: 'ðŸ”' },
            { id: 'qpc', name: 'Quarter Pounder w/ Cheese', price: 5.39, mealPrice: 9.49, category: 'Burgers', img: 'ðŸ”' },
            { id: 'qpc_deluxe', name: 'QPC Deluxe', price: 7.19, mealPrice: 11.29, category: 'Burgers', img: 'ðŸ”' },
            { id: 'qpc_bacon', name: 'Bacon QPC', price: 7.39, mealPrice: 11.49, category: 'Burgers', img: 'ðŸ¥“' },
            { id: 'qpc_double', name: 'Double QPC', price: 7.89, mealPrice: 11.99, category: 'Burgers', img: 'ðŸ”' },
            { id: 'qpc_double_bacon', name: 'Double Bacon QPC', price: 9.29, mealPrice: 13.49, category: 'Burgers', img: 'ðŸ¥“' },
            { id: 'daily_double', name: 'Daily Double', price: 4.29, mealPrice: 7.89, category: 'Burgers', img: 'ðŸ”' },
            { id: 'mcdouble', name: 'McDouble', price: 3.19, mealPrice: 6.99, category: 'Burgers', img: 'ðŸ”' },
            { id: 'bacon_mcdouble', name: 'Bacon McDouble', price: 4.49, mealPrice: 8.29, category: 'Burgers', img: 'ðŸ¥“' },
            { id: 'hamburger', name: 'Hamburger', price: 2.39, category: 'Burgers', img: 'ðŸ”' },
            { id: 'cheeseburger', name: 'Cheeseburger', sizes: { 'Single': 2.49, 'Double': 3.59, 'Triple': 4.89 }, category: 'Burgers', img: 'ðŸ”' },
            { id: 'filet_o_fish', name: 'Filet-O-Fish', sizes: { 'Single': 5.29, 'Double': 6.49 }, mealPrice: 9.39, category: 'Burgers', img: 'ðŸŸ' },

            // Chicken
            { id: 'mccrispy', name: 'McCrispyÂ®', sizes: { 'Regular': 4.99, 'Deluxe': 6.29, 'Spicy': 4.99, 'Spicy Deluxe': 6.49 }, mealPrice: 9.49, category: 'Chicken', img: 'ðŸ¥ª' },
            { id: 'mcchicken', name: 'McChickenÂ®', sizes: { 'Regular': 2.89, 'Hot n Spicy': 2.99 }, mealPrice: 6.49, category: 'Chicken', img: 'ðŸ—' },
            { id: 'nuggets', name: 'McNuggets', sizes: { '4pc': 3.19, '6pc': 4.69, '10pc': 6.49, '20pc': 9.39, '40pc': 17.19 }, mealPrice: 10.49, category: 'Chicken', img: 'ðŸ—' },
            { id: 'snack_wrap', name: 'Snack WrapÂ®', sizes: { 'Ranch': 2.99, 'Spicy': 2.99 }, category: 'Chicken', img: 'ðŸŒ¯' },
            { id: 'mccrispy_strips', name: 'McCrispyâ„¢ Strips', sizes: { '3pc': 5.29, '4pc': 6.29 }, mealPrice: 10.29, category: 'Chicken', img: 'ðŸ—' },

            // Sides
            { id: 'fries', name: 'Fries', sizes: { 'S': 2.99, 'M': 3.99, 'L': 4.79 }, category: 'Sides', img: 'ðŸŸ' },
            { id: 'app', name: 'Apple Slices', price: 1.00, category: 'Sides', img: 'ðŸŽ' },

            // Happy Meals
            { id: 'hm_hamburger', name: 'Hamburger Happy Meal', price: 4.59, category: 'Happy Meals', img: 'ðŸŽ' },
            { id: 'hm_nuggets', name: '4pc Nugget Happy Meal', price: 4.99, category: 'Happy Meals', img: 'ðŸŽ' },
            { id: 'hm_nuggets_6', name: '6pc Nugget Happy Meal', price: 5.49, category: 'Happy Meals', img: 'ðŸŽ' },

            // Drinks
            { id: 'fountain_drink', name: 'Fountain Drink', sizes: { 'S': 1.49, 'M': 1.69, 'L': 1.89 }, category: 'Drinks', img: 'ðŸ¥¤' },
            { id: 'sweet_tea', name: 'Sweet Tea', sizes: { 'S': 1.49, 'M': 1.69, 'L': 1.89 }, category: 'Drinks', img: 'ðŸ¥¤' },
            
            { id: 'hot_coffee', name: 'Premium Coffee', sizes: { 'S': 1.59, 'M': 1.89, 'L': 2.19 }, category: 'Drinks', img: 'â˜•' },
            { id: 'decaf_coffee', name: 'Decaf Coffee', sizes: { 'S': 1.59, 'M': 1.89, 'L': 2.19 }, category: 'Drinks', img: 'â˜•' },
            { id: 'iced_coffee', name: 'Iced Coffee', sizes: { 'S': 2.29, 'M': 2.59, 'L': 2.79 }, category: 'Drinks', img: 'ðŸ§‹' },
            { id: 'iced_coffee_flavored', name: 'Flavored Iced Coffee', sizes: { 'Caramel S': 2.29, 'Caramel M': 2.59, 'Caramel L': 2.79, 'Fr. Van S': 2.29, 'Fr. Van M': 2.59, 'Fr. Van L': 2.79 }, category: 'Drinks', img: 'ðŸ§‹' },
            { id: 'lemonade', name: 'Lemonade', sizes: { 'S': 1.99, 'M': 2.39, 'L': 2.69 }, category: 'Drinks', img: 'ðŸ‹' },
            { id: 'oj', name: 'Orange Juice', sizes: { 'S': 2.89, 'M': 3.39, 'L': 3.99 }, category: 'Drinks', img: 'ðŸŠ' },
            { id: 'milk', name: 'Milk', sizes: { 'White': 1.19, 'Chocolate': 1.19 }, category: 'Drinks', img: 'ðŸ¥›' },
            { id: 'frozen_drink', name: 'Frozen Drink', sizes: { 'Coke S': 2.39, 'Coke M': 2.59, 'Coke L': 2.79, 'Blue Rasp S': 2.39, 'Blue Rasp M': 2.59, 'Blue Rasp L': 2.79, 'Cherry S': 2.39, 'Cherry M': 2.59, 'Cherry L': 2.79 }, category: 'Drinks', img: 'ðŸ§Š' },
            
            // McCafe
            { id: 'espresso_drinks', name: 'Espresso/Latte/Mocha', sizes: { 'Latte S': 2.69, 'Latte M': 3.59, 'Latte L': 4.49, 'Mocha S': 2.69, 'Mocha M': 3.59, 'Mocha L': 4.49, 'Cappuccino S': 2.69, 'Cappuccino M': 3.59, 'Cappuccino L': 4.49, 'Caramel Macchiato S': 2.69, 'Caramel Macchiato M': 3.59, 'Caramel Macchiato L': 4.49, 'Americano S': 2.69, 'Americano M': 3.59, 'Americano L': 4.49 }, category: 'McCafÃ©', img: 'â˜•' },
            { id: 'frappe', name: 'FrappÃ©', sizes: { 'Caramel S': 4.59, 'Caramel M': 4.99, 'Caramel L': 5.49, 'Mocha S': 4.59, 'Mocha M': 4.99, 'Mocha L': 5.49 }, category: 'McCafÃ©', img: 'ðŸ¥¤' },
            { id: 'smoothie', name: 'Smoothie', sizes: { 'Strawberry S': 3.99, 'Strawberry M': 4.49, 'Strawberry L': 5.19, 'Mango S': 3.99, 'Mango M': 4.49, 'Mango L': 5.19 }, category: 'McCafÃ©', img: 'ðŸ“' },
            { id: 'hot_chocolate', name: 'Hot Chocolate', sizes: { 'S': 2.39, 'M': 2.89, 'L': 3.39 }, category: 'McCafÃ©', img: 'ðŸ«' },

            // Sweets
            { id: 'shake', name: 'Shake', sizes: { 'S': 3.29, 'M': 3.89, 'L': 4.39 }, category: 'Sweets', img: 'ðŸ¥¤' },
            { id: 'mcflurry', name: 'McFlurry', price: 3.89, category: 'Sweets', img: 'ðŸ¦' },
            { id: 'applepie', name: 'Apple Pie', price: 1.69, category: 'Sweets', img: 'ðŸ¥§' },
            { id: 'cookie', name: 'Cookie', sizes: { '1pc': 1.19, '3pc': 2.59 }, category: 'Sweets', img: 'ðŸª' }
        ];

        // --- DEALS ---
        const autoBogoDeal = { 
            id: 'auto_bogo', 
            name: 'Auto BOGO $1', 
            type: 'bogo_specific_list', 
            bogoPrice: 1.00, 
            targets: ['mcchicken', 'cheeseburger', 'nuggets', 'fries', 'sausage_biscuit', 'sausage_mcmuffin', 'sausage_burrito', 'hashbrown'] 
        };

        let activeDeals = [
            // Image 1 Deals
            { id: 'deal_free_cov_soda', name: 'FREE Sm Coffee or Sm Soft Drink', type: 'fixed_price_item', price: 0.00, targets: [{id:'hot_coffee', size:'S'}, {id:'fountain_drink', size:'S'}], active: true },
            { id: 'deal_bogo_50', name: 'BOGO $0.50 Breakfast Sandwich', type: 'bogo_category', targetCat: 'Breakfast', bogoPrice: 0.50, active: true },
            { id: 'deal_99_coffee', name: '$0.99 Any Size Premium/Iced Coffee', type: 'fixed_price_group', price: 0.99, targets: ['hot_coffee', 'iced_coffee', 'iced_coffee_flavored', 'decaf_coffee'], active: true },

            // Image 2 Deals
            { id: 'deal_559_meal', name: '$5.59 Meal (Big Mac/QPC/3pc + M Fry + M Drink)', type: 'combo_fixed', price: 5.59, components: [{id:'bigmac'}, {id:'qpc'}, {id:'mccrispy_strips', size:'3pc'}], sides: [{id:'fries', size:'M'}], drinks: [{id:'fountain_drink', size:'M'}], active: true },
            { id: 'deal_15_off_12', name: '15% off $12+ (Excludes Tax)', type: 'percent', val: 15, minSpend: 12, active: true },
            { id: 'deal_779_pack', name: '$7.79 20pc Nuggets + 2 Med Fries', type: 'combo_fixed', price: 7.79, components: [{id:'nuggets', size:'20pc'}], sides: [{id:'fries', size:'M'}], sideCount: 2, drinks: [], active: true },
            { id: 'deal_free_fry_dbl', name: 'FREE Med Fry w/ Double Cheeseburger', type: 'free_item_with_item', buyId: 'cheeseburger', buySize: 'Double', getId: 'fries', getSize: 'M', active: true },
            { id: 'deal_delivery_free_10pc', name: 'Free 10pc Nug/Crispy w/ $15+ (Delivery)', type: 'free_item_category', targetCat: 'Chicken', exclude: ['mccrispy_strips', 'snack_wrap', 'mcchicken'], minSpend: 15, active: true },

            // Legacy Deals (Kept if reasonable)
            { id: 'deal_40_off', name: '40% off Double Cheeseburger or 6pc Nuggets', type: 'percent_off_item', val: 40, targets: [{id:'cheeseburger', size:'Double'}, {id:'nuggets', size:'6pc'}], active: true },
            { id: 'deal_20_off_12', name: '20% off purchase of $12+', type: 'percent', val: 20, minSpend: 12, active: true },
            { id: 'deal_139_fry', name: '$1.39 Any Size Fries', type: 'fixed_price_item', targetId: 'fries', price: 1.39, active: true }
        ];

        let cart = [];

        // --- UI LOGIC ---
        function init() {
            renderCategories();
            renderMenu('Burgers');
            renderDeals();
            updateCartDisplay();
        }

        function renderCategories() {
            const categories = [...new Set(menu.map(item => item.category))];
            const nav = document.getElementById('categoryNav');
            nav.innerHTML = categories.map(cat => 
                `<button onclick="renderMenu('${cat}')" class="px-4 py-2 text-sm font-semibold text-gray-600 hover:text-black hover:bg-gray-200 rounded-full mx-1 transition-colors focus:bg-yellow-400 focus:text-black focus:outline-none">${cat}</button>`
            ).join('');
            if(nav.children[0]) nav.children[0].click();
        }

        function renderMenu(category) {
            const container = document.getElementById('menuGrid');
            container.innerHTML = menu.filter(i => i.category === category).map(item => {
                let priceHtml = '';
                let selectorHtml = '';
                let buttonsHtml = '';
                
                if (item.sizes) {
                    const sizeKeys = Object.keys(item.sizes);
                    const firstPrice = item.sizes[sizeKeys[0]];
                    selectorHtml = `
                        <select id="size-${item.id}" onchange="updateCardPrice('${item.id}')" class="w-full mb-2 text-xs p-1 border rounded bg-gray-50">
                            ${sizeKeys.map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    `;
                    priceHtml = `<span id="price-${item.id}">$${firstPrice.toFixed(2)}</span>`;
                } else {
                    priceHtml = `<span>$${item.price.toFixed(2)}</span>`;
                }

                // Standard Add Button
                buttonsHtml = `
                    <button onclick="addItemFromCard('${item.id}')" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs font-bold px-3 py-1.5 rounded flex-1">
                        Add Item
                    </button>`;

                // Meal Button (if applicable)
                if (item.mealPrice) {
                    buttonsHtml += `
                    <button onclick="addMealFromCard('${item.id}')" class="ml-2 bg-yellow-400 hover:bg-yellow-500 text-black text-xs font-bold px-3 py-1.5 rounded flex-1">
                        Add Meal
                    </button>`;
                }

                return `
                <div class="bg-white p-3 rounded-lg shadow border border-gray-100 hover:shadow-md transition-transform active:scale-95 flex flex-col justify-between h-full relative group">
                    <div class="flex-1 flex flex-col items-center mb-2">
                        <div class="text-3xl mb-2 text-center">${item.img}</div>
                        <div class="font-bold text-sm leading-tight text-gray-800 text-center">${item.name}</div>
                    </div>
                    ${selectorHtml}
                    <div class="font-mono text-sm font-bold text-gray-600 text-center mb-2">${priceHtml}</div>
                    <div class="flex items-center justify-between mt-auto w-full">
                        ${buttonsHtml}
                    </div>
                </div>
            `}).join('');
        }

        function updateCardPrice(itemId) {
            const item = menu.find(i => i.id === itemId);
            const select = document.getElementById(`size-${itemId}`);
            const display = document.getElementById(`price-${itemId}`);
            if(item && select && display) {
                const price = item.sizes[select.value];
                display.innerText = '$' + price.toFixed(2);
            }
        }

        function addItemFromCard(itemId) {
            const item = menu.find(i => i.id === itemId);
            let size = null;
            let price = item.price;
            if (item.sizes) {
                const select = document.getElementById(`size-${itemId}`);
                size = select ? select.value : Object.keys(item.sizes)[0];
                price = item.sizes[size];
            }
            addToCart(itemId, size, price, item.name, false);
        }

        function addMealFromCard(itemId) {
            const item = menu.find(i => i.id === itemId);
            const mealId = itemId + "_meal";
            const mealName = item.name + " Meal";
            addToCart(mealId, null, item.mealPrice, mealName, true);
        }

        function addToCart(id, size, price, name, isMeal) {
            const existing = cart.find(i => i.id === id && i.size === size);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ id, size, price, name, quantity: 1, isMeal: isMeal });
            }
            updateCartDisplay();
        }

        function updateQty(index, change) {
            if (cart[index]) {
                cart[index].quantity += change;
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                }
            }
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const container = document.getElementById('cartContainer');
            let subtotal = 0;
            
            // Calc total first for header
            cart.forEach(i => subtotal += i.price * i.quantity);
            document.getElementById('mobileHeaderTotal').innerText = '$' + subtotal.toFixed(2);
            document.getElementById('subtotalDisplay').innerText = '$' + subtotal.toFixed(2);
            document.getElementById('totalDisplay').innerText = '$' + subtotal.toFixed(2);
            
            // Update Badge
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            const badge = document.getElementById('cartBadge');
            if(count > 0) {
                badge.classList.remove('hidden');
                badge.innerText = count;
            } else {
                badge.classList.add('hidden');
            }

            if (cart.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-10 text-sm">Your tray is empty.</div>`;
                return;
            }

            let html = '';
            cart.forEach((item, index) => {
                let displayName = item.size ? `${item.name} (${item.size})` : item.name;
                if (item.isMeal) displayName = `<span class="text-purple-700 font-bold"><i class="fas fa-utensils text-xs"></i> ${displayName}</span>`;

                html += `
                    <div class="flex justify-between items-center bg-white p-2 rounded border shadow-sm">
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800 leading-tight">${displayName}</div>
                            <div class="text-xs text-gray-500">$${item.price.toFixed(2)} ea</div>
                        </div>
                        <div class="flex items-center gap-2 ml-2">
                            <button onclick="updateQty(${index}, -1)" class="w-6 h-6 bg-gray-100 rounded text-gray-600 hover:bg-gray-200 flex items-center justify-center">-</button>
                            <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                            <button onclick="updateQty(${index}, 1)" class="w-6 h-6 bg-gray-100 rounded text-gray-600 hover:bg-gray-200 flex items-center justify-center">+</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- DEALS UI ---
        function renderDeals() {
            const list = document.getElementById('dealsList');
            list.innerHTML = activeDeals.map(deal => `
                <div class="flex items-start gap-3 p-3 border rounded-lg ${deal.active ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-200'}">
                    <input type="checkbox" onchange="toggleDeal('${deal.id}')" ${deal.active ? 'checked' : ''} class="mt-1 w-4 h-4 text-red-600 rounded focus:ring-red-500">
                    <div class="flex-1">
                        <div class="text-sm font-bold text-gray-800 leading-tight">${deal.name}</div>
                        ${deal.minSpend > 0 ? `<div class="text-xs text-gray-500 mt-1">Min. Spend: $${deal.minSpend}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function toggleDeal(id) {
            const deal = activeDeals.find(d => d.id === id);
            if(deal) deal.active = !deal.active;
            renderDeals();
        }

        // --- CALCULATION HELPER: AUTO BUNDLING ---
        function calculateBaseline(cartItems) {
            let tempCart = cartItems.map(i => ({...i})); 
            let originalTotal = tempCart.reduce((s, i) => s + i.price, 0);
            let currentTotal = originalTotal;
            
            let mealSavings = 0;
            let mains = tempCart.filter(i => { const m = menu.find(x => x.id === i.id); return m && m.mealPrice && !i.isMeal; });
            let fries = tempCart.filter(i => i.id === 'fries' && i.size === 'M');
            let drinks = tempCart.filter(i => i.id === 'fountain_drink' && i.size === 'M');

            while(mains.length > 0 && fries.length > 0 && drinks.length > 0) {
                const main = mains.pop(); const fry = fries.pop(); const drink = drinks.pop();
                const menuItem = menu.find(x => x.id === main.id);
                const bundlePrice = menuItem.mealPrice;
                const separatePrice = main.price + fry.price + drink.price;

                if (bundlePrice < separatePrice) {
                    const save = separatePrice - bundlePrice;
                    mealSavings += save;
                    currentTotal -= save;
                    tempCart = tempCart.filter(x => x._id !== main._id && x._id !== fry._id && x._id !== drink._id);
                }
            }

            let bogoSavings = 0;
            const eligibleForBogo = tempCart.filter(i => {
                if(i.isMeal) return false; 
                if(autoBogoDeal.targets.includes(i.id)) {
                    if(i.id === 'cheeseburger' && i.size !== 'Double') return false;
                    if(i.id === 'nuggets' && i.size !== '6pc') return false;
                    if(i.id === 'fries' && i.size !== 'S') return false;
                    if(i.id === 'mcchicken' && i.size !== 'Regular') return false;
                    return true;
                }
                return false;
            });
            const numPairs = Math.floor(eligibleForBogo.length / 2);
            if (numPairs > 0) {
                eligibleForBogo.sort((a, b) => b.price - a.price);
                for (let i = 0; i < numPairs; i++) {
                    const discount = eligibleForBogo[i * 2 + 1].price - autoBogoDeal.bogoPrice;
                    if (discount > 0) { 
                        currentTotal -= discount; 
                        bogoSavings += discount; 
                    }
                }
            }

            return {
                total: currentTotal,
                mealSavings: mealSavings,
                bogoSavings: bogoSavings,
                remainingItems: tempCart
            };
        }

        // --- MAIN CALCULATION ---
        function calculateBestDeal() {
            if (cart.length === 0) { alert("Cart is empty."); return; }
            
            let flatCart = [];
            cart.forEach(item => {
                for(let i=0; i<item.quantity; i++) flatCart.push({ ...item, _id: Math.random() });
            });

            const originalTotal = flatCart.reduce((sum, i) => sum + i.price, 0);
            const baseline = calculateBaseline(flatCart);
            
            let bestScenario = {
                name: "No Additional Deals",
                total: baseline.total,
                dealSavings: 0,
                mealSavings: baseline.mealSavings,
                autoSavings: baseline.bogoSavings
            };

            const enabledDeals = activeDeals.filter(d => d.active);

            enabledDeals.forEach(deal => {
                let tempCart = flatCart.map(i => ({...i})); 
                let currentTotal = originalTotal;
                let dealSavings = 0;
                let isValid = false;

                if (deal.type === 'percent') {
                    if (baseline.total >= deal.minSpend) {
                        dealSavings = baseline.total * (deal.val/100);
                        isValid = true;
                         if ((baseline.total - dealSavings) < bestScenario.total) {
                            bestScenario = {
                                name: deal.name,
                                total: baseline.total - dealSavings,
                                dealSavings: dealSavings,
                                mealSavings: baseline.mealSavings,
                                autoSavings: baseline.bogoSavings
                            };
                        }
                        return;
                    }
                }
                else if (deal.type === 'fixed_off') {
                    if (baseline.total >= deal.minSpend) {
                        dealSavings = deal.val;
                        isValid = true;
                         if ((baseline.total - dealSavings) < bestScenario.total) {
                            bestScenario = {
                                name: deal.name,
                                total: baseline.total - dealSavings,
                                dealSavings: dealSavings,
                                mealSavings: baseline.mealSavings,
                                autoSavings: baseline.bogoSavings
                            };
                        }
                        return;
                    }
                }
                else if (deal.type === 'fixed_price_item') {
                    let match = null;
                    if(Array.isArray(deal.targets)) {
                        match = tempCart.find(i => !i.isMeal && deal.targets.some(t => t.id === i.id && (!t.size || i.size === t.size)));
                    } else {
                        match = tempCart.find(i => !i.isMeal && i.id === deal.targetId);
                    }
                    if (match) {
                        dealSavings = match.price - deal.price;
                        if(dealSavings > 0) {
                            isValid = true;
                            currentTotal -= dealSavings;
                            tempCart = tempCart.filter(x => x._id !== match._id);
                        }
                    }
                }
                else if (deal.type === 'percent_off_item') {
                     const match = tempCart.find(i => !i.isMeal && deal.targets.some(t => t.id === i.id && (!t.size || i.size === t.size)));
                     if (match) {
                         dealSavings = match.price * (deal.val / 100);
                         isValid = true;
                         currentTotal -= dealSavings;
                         tempCart = tempCart.filter(x => x._id !== match._id);
                     }
                }
                else if (deal.type === 'fixed_price_group') {
                    const match = tempCart.find(i => !i.isMeal && deal.targets.includes(i.id));
                    if (match) {
                        dealSavings = match.price - deal.price;
                        isValid = dealSavings > 0;
                         if(isValid) {
                            currentTotal -= dealSavings;
                            tempCart = tempCart.filter(x => x._id !== match._id);
                         }
                    }
                }
                else if (deal.type === 'combo_fixed') {
                    const mains = tempCart.filter(i => !i.isMeal && deal.components.some(c => c.id === i.id && (!c.size || c.size === i.size)));
                    const sides = tempCart.filter(i => !i.isMeal && deal.sides.some(s => s.id === i.id && s.size === i.size));
                    const drinks = deal.drinks.length > 0 
                        ? tempCart.filter(i => !i.isMeal && deal.drinks.some(d => d.id === i.id && d.size === i.size))
                        : [];
                    
                    const reqSides = deal.sideCount || 1;
                    const reqDrinks = deal.drinks.length > 0 ? 1 : 0;

                    if(mains.length > 0 && sides.length >= reqSides && (reqDrinks === 0 || drinks.length > 0)) {
                        const main = mains[0];
                        const usedSides = sides.slice(0, reqSides);
                        const usedDrink = reqDrinks > 0 ? drinks[0] : null;

                        let totalSep = main.price;
                        usedSides.forEach(s => totalSep += s.price);
                        if(usedDrink) totalSep += usedDrink.price;

                        dealSavings = totalSep - deal.price;
                        
                        if (dealSavings > 0) {
                            isValid = true;
                            currentTotal -= dealSavings;
                            let idsToRemove = [main._id, ...usedSides.map(s=>s._id)];
                            if(usedDrink) idsToRemove.push(usedDrink._id);
                            tempCart = tempCart.filter(x => !idsToRemove.includes(x._id));
                        }
                    }
                }
                else if (deal.type === 'free_item_with_item') {
                    const buyItem = tempCart.find(i => i.id === deal.buyId && (!deal.buySize || i.size === deal.buySize));
                    const getItem = tempCart.find(i => i.id === deal.getId && (!deal.getSize || i.size === deal.getSize) && i._id !== buyItem?._id);
                    if (buyItem && getItem) {
                        dealSavings = getItem.price;
                        isValid = true;
                        currentTotal -= dealSavings;
                        tempCart = tempCart.filter(x => x._id !== getItem._id);
                    }
                }
                else if (deal.type === 'free_item_category' || deal.type === 'free_item') {
                     let target = null;
                     if(deal.type === 'free_item') {
                        target = tempCart.find(i => !i.isMeal && i.id === deal.targetId && (!deal.targetSize || i.size === deal.targetSize));
                     } else {
                        const matches = tempCart.filter(i => {
                            const mItem = menu.find(m => m.id === i.id);
                            return !i.isMeal && mItem && mItem.category.includes(deal.targetCat) && !deal.exclude.includes(i.id);
                        });
                        matches.sort((a, b) => b.price - a.price); 
                        if(matches.length > 0) target = matches[0];
                     }

                     if(target) {
                         if ((originalTotal - target.price) >= deal.minSpend) {
                             dealSavings = target.price;
                             isValid = true;
                             currentTotal -= dealSavings;
                             tempCart = tempCart.filter(x => x._id !== target._id);
                         }
                     }
                }

                if(isValid) {
                    const remainderResult = calculateBaseline(tempCart);
                    const finalTotal = currentTotal - remainderResult.mealSavings - remainderResult.bogoSavings;
                    
                    if(finalTotal < bestScenario.total) {
                        bestScenario = {
                            name: deal.name,
                            total: finalTotal,
                            dealSavings: dealSavings,
                            mealSavings: remainderResult.mealSavings,
                            autoSavings: remainderResult.bogoSavings
                        };
                    }
                }
            });

            const totalSavings = originalTotal - bestScenario.total;
            showResult(originalTotal, bestScenario.total, totalSavings, bestScenario.mealSavings, bestScenario.autoSavings, bestScenario.dealSavings, bestScenario.name);
        }

        function showResult(orig, newP, totalSave, mealSave, autoSave, dealSave, dealName) {
            document.getElementById('resultOriginal').innerText = '$' + orig.toFixed(2);
            document.getElementById('resultNew').innerText = '$' + newP.toFixed(2);
            
            const savingsEl = document.getElementById('resultSavings');
            savingsEl.innerText = '$' + totalSave.toFixed(2);
            
            const titleEl = document.getElementById('resultTitle');
            if (totalSave > 0) {
                titleEl.innerText = "Savings Found!";
                savingsEl.className = "text-xl font-bold text-green-600";
            } else {
                titleEl.innerText = "Best Price Found";
                savingsEl.className = "text-xl font-bold text-gray-500";
            }
            
            const mealRow = document.getElementById('mealSavingsRow');
            const autoRow = document.getElementById('autoSavingsRow');
            const dealRow = document.getElementById('dealSavingsRow');
            
            if(mealSave > 0) {
                mealRow.classList.remove('hidden');
                document.getElementById('mealSavingsVal').innerText = '-$' + mealSave.toFixed(2);
            } else { mealRow.classList.add('hidden'); }

            if(autoSave > 0) {
                autoRow.classList.remove('hidden');
                document.getElementById('autoSavingsVal').innerText = '-$' + autoSave.toFixed(2);
            } else { autoRow.classList.add('hidden'); }

            if(dealSave > 0) {
                dealRow.classList.remove('hidden');
                document.getElementById('dealNameDisplay').innerText = '+ ' + dealName;
                document.getElementById('dealSavingsVal').innerText = '-$' + dealSave.toFixed(2);
            } else { dealRow.classList.add('hidden'); }

            document.getElementById('resultModal').classList.remove('hidden');
            document.getElementById('resultModal').classList.add('flex');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function toggleCustomDealModal() {
            document.getElementById('customDealModal').classList.remove('hidden');
            document.getElementById('customDealModal').classList.add('flex');
        }
        function toggleCustomFields() {
            const type = document.getElementById('customType').value;
            document.getElementById('field-percent').classList.toggle('hidden', type !== 'percent');
            document.getElementById('field-amount').classList.toggle('hidden', type !== 'fixed_off');
        }
        function addCustomDeal() {
            const name = document.getElementById('customName').value;
            const type = document.getElementById('customType').value;
            const min = parseFloat(document.getElementById('customMinSpend').value) || 0;
            let d = { id: 'c'+Date.now(), name, type, minSpend: min, active: true };
            if(type === 'percent') d.val = parseFloat(document.getElementById('customValPercent').value);
            if(type === 'fixed_off') d.val = parseFloat(document.getElementById('customValAmount').value);
            activeDeals.push(d);
            renderDeals();
            closeModal('customDealModal');
        }

        init();
    </script>
</body>
</html>
